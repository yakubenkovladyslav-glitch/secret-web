<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precise Media Gallery</title>
    <link rel="stylesheet" href="style.css">
    <!-- Load the list generated by Python -->
    <script src="media_list.js"></script> 
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>Private Access</h2>
            <form onsubmit="handleLogin(event)">
                <input type="password" id="password-input" placeholder="Enter Password" autofocus>
                <button type="submit">Unlock</button>
            </form>
            <p id="error-msg" class="error-msg">Access Denied</p>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox">
        <!-- Controls -->
        <div class="lb-controls">
            <span class="close-btn" onclick="closeLightbox()">&times;</span>
            <div class="lb-counter"><span id="lb-current">1</span> / <span id="lb-total">0</span></div>
        </div>

        <!-- Navigation Areas -->
        <div class="nav-area prev" onclick="changeMedia(-1)">&#10094;</div>
        <div class="nav-area next" onclick="changeMedia(1)">&#10095;</div>

        <!-- Content Container -->
        <div id="lightbox-wrapper">
            <div class="spinner" id="lb-spinner"></div>
            <img id="lightbox-img" draggable="false" alt="Gallery Item">
            <video id="lightbox-video" controls style="display:none;"></video>
        </div>
    </div>

    <!-- GALLERY GRID -->
    <main id="gallery-content" style="display:none;">
        <header>
            <h1>Collection (<span id="count">0</span>)</h1>
        </header>
        <div class="media-grid" id="grid-container"></div>
    </main>

    <script>
        // CONFIG
        const folderPath = "private-media/";
        // SHA-256 hash for "1234"
        const AUTH_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4";

        let currentIndex = 0;
        
        // --- 1. AUTHENTICATION (HASH BASED) ---
        async function handleLogin(e) {
            e.preventDefault();
            const input = document.getElementById("password-input").value;
            const errorMsg = document.getElementById("error-msg");

            // Simple hash function using browser crypto API
            const msgBuffer = new TextEncoder().encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            if (hashHex === AUTH_HASH) {
                document.getElementById("login-overlay").style.display = "none";
                document.getElementById("gallery-content").style.display = "block";
                loadGallery();
            } else {
                errorMsg.style.display = "block";
                document.getElementById("password-input").value = "";
            }
        }

        // --- 2. GALLERY LOADER ---
        function loadGallery() {
            if (typeof mediaList === 'undefined') {
                alert("Error: Run scan_files.py first!");
                return;
            }

            const container = document.getElementById('grid-container');
            document.getElementById('count').innerText = mediaList.length;
            document.getElementById('lb-total').innerText = mediaList.length;

            mediaList.forEach((filename, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                
                // Determine Type
                const ext = filename.split('.').pop().toLowerCase();
                const isVideo = ['mp4', 'webm', 'mov', 'avi'].includes(ext);
                const fullPath = folderPath + filename;

                // Create Thumbnail (For video, we ideally need a poster, but we'll use a generic icon or the video tag muted)
                let mediaEl;
                if (isVideo) {
                    mediaEl = document.createElement('video');
                    mediaEl.src = fullPath + "#t=0.1"; // Seek to 0.1s for thumbnail
                    mediaEl.preload = "metadata";
                    mediaEl.className = "lazy grid-video";
                } else {
                    mediaEl = document.createElement('img');
                    mediaEl.dataset.src = fullPath;
                    mediaEl.className = "lazy";
                    mediaEl.loading = "lazy";
                }

                // Click to Open Lightbox
                card.onclick = () => openLightbox(index);
                card.appendChild(mediaEl);
                container.appendChild(card);
            });

            initLazyLoading();
        }

        function initLazyLoading() {
            const targets = document.querySelectorAll(".lazy");
            const obs = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        if(el.tagName === 'IMG') el.src = el.dataset.src;
                        el.classList.remove("lazy");
                        observer.unobserve(el);
                    }
                });
            });
            targets.forEach(t => obs.observe(t));
        }

        // --- 3. LIGHTBOX LOGIC ---
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        const lbVid = document.getElementById('lightbox-video');
        const lbSpinner = document.getElementById('lb-spinner');
        
        // Zoom State
        let transformState = { scale: 1, x: 0, y: 0 };
        let isDragging = false;
        let startPos = { x: 0, y: 0 };

        function openLightbox(index) {
            currentIndex = index;
            lightbox.style.display = "flex";
            updateLightboxContent();
            document.addEventListener('keydown', handleKeyInput);
        }

        function closeLightbox() {
            lightbox.style.display = "none";
            lbVid.pause();
            lbVid.src = "";
            document.removeEventListener('keydown', handleKeyInput);
        }

        function changeMedia(direction) {
            currentIndex += direction;
            // Loop functionality
            if (currentIndex < 0) currentIndex = mediaList.length - 1;
            if (currentIndex >= mediaList.length) currentIndex = 0;
            
            updateLightboxContent();
        }

        function updateLightboxContent() {
            // Reset Zoom
            resetZoom();
            
            const filename = mediaList[currentIndex];
            const fullPath = folderPath + filename;
            const ext = filename.split('.').pop().toLowerCase();
            const isVideo = ['mp4', 'webm', 'mov', 'avi'].includes(ext);

            document.getElementById('lb-current').innerText = currentIndex + 1;
            lbSpinner.style.display = "block";

            if (isVideo) {
                lbImg.style.display = "none";
                lbVid.style.display = "block";
                lbVid.src = fullPath;
                lbVid.onloadstart = () => { lbSpinner.style.display = "none"; };
            } else {
                lbVid.style.display = "none";
                lbVid.pause();
                lbImg.style.display = "block";
                lbImg.src = fullPath;
                lbImg.onload = () => { lbSpinner.style.display = "none"; };
            }
        }

        function handleKeyInput(e) {
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowLeft") changeMedia(-1);
            if (e.key === "ArrowRight") changeMedia(1);
        }

        // --- 4. TOUCH & ZOOM LOGIC (Simplified) ---
        // Double Tap to Zoom / Reset
        let lastTap = 0;
        lightbox.addEventListener('touchend', function (e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                if (transformState.scale > 1) resetZoom();
                else {
                    // Zoom to point (simplified to 2.5x center for stability)
                    transformState.scale = 2.5;
                    updateTransform();
                }
                e.preventDefault();
            }
            lastTap = currentTime;
        });

        // Wheel Zoom
        lightbox.addEventListener('wheel', (e) => {
            if(lbVid.style.display === 'block') return; // Don't zoom videos
            e.preventDefault();
            const delta = -Math.sign(e.deltaY) * 0.5;
            const newScale = Math.min(Math.max(1, transformState.scale + delta), 5);
            transformState.scale = newScale;
            if(newScale === 1) { transformState.x = 0; transformState.y = 0; }
            updateTransform();
        }, { passive: false });

        // Touch handling for Swipe vs Pan
        let touchStart = { x: 0, y: 0 };
        
        lightbox.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchStart.x = e.touches[0].clientX;
                touchStart.y = e.touches[0].clientY;
                startPos.x = transformState.x;
                startPos.y = transformState.y;
            }
        });

        lightbox.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) {
                const dx = e.touches[0].clientX - touchStart.x;
                const dy = e.touches[0].clientY - touchStart.y;

                if (transformState.scale > 1) {
                    // PANNING
                    e.preventDefault();
                    transformState.x = startPos.x + dx;
                    transformState.y = startPos.y + dy;
                    updateTransform();
                } 
            }
        }, { passive: false });

        lightbox.addEventListener('touchend', (e) => {
            if (e.changedTouches.length === 1 && transformState.scale === 1) {
                // SWIPE DETECTION (Only if not zoomed)
                const dx = e.changedTouches[0].clientX - touchStart.x;
                if (Math.abs(dx) > 50) { // Threshold
                    changeMedia(dx > 0 ? -1 : 1);
                }
            }
        });

        function resetZoom() {
            transformState = { scale: 1, x: 0, y: 0 };
            updateTransform();
        }

        function updateTransform() {
            lbImg.style.transform = `translate(${transformState.x}px, ${transformState.y}px) scale(${transformState.scale})`;
        }

    </script>
</body>
</html>