<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport optimized for mobile: prevents auto-zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precise Media Gallery</title>
    <link rel="stylesheet" href="style.css">
    <script src="media_list.js"></script> 
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>Private Access</h2>
            <input type="password" id="password-input" placeholder="Enter Password">
            <button onclick="checkPassword()">Unlock</button>
            <p id="error-msg" style="color:red; display:none; margin-top:10px;">Wrong Password</p>
        </div>
    </div>

    <!-- LIGHTBOX OVERLAY -->
    <div id="lightbox">
        <div class="lightbox-hint">Double Tap to Close</div>
        
        <!-- Navigation Buttons -->
        <div class="nav-btn prev" onclick="changeImage(-1, event)">&#10094;</div>
        <div class="nav-btn next" onclick="changeImage(1, event)">&#10095;</div>

        <img id="lightbox-img" src="" alt="Full Screen">
    </div>

    <!-- GALLERY -->
    <main id="gallery-content" style="display:none;">
        <h1>My Collection (<span id="count">0</span> items)</h1>
        <div class="media-grid" id="grid-container"></div>
    </main>

    <script>
        // --- AUTH ---
        function checkPassword() {
            if (document.getElementById("password-input").value === "1234") {
                document.getElementById("login-overlay").style.display = "none";
                document.getElementById("gallery-content").style.display = "block";
                loadGallery();
            } else {
                document.getElementById("error-msg").style.display = "block";
            }
        }

        // --- GLOBAL VARS ---
        let currentIndex = 0;
        let currentFiles = []; // Store only images here

        // --- LOADER ---
        function loadGallery() {
            const container = document.getElementById('grid-container');
            const folderPath = "private-media/";
            
            if (typeof mediaList === 'undefined') return alert("Run python script first!");
            document.getElementById('count').innerText = mediaList.length;

            // Filter list to keep index sync simple
            mediaList.forEach((filename, index) => {
                currentFiles.push(filename); // Store index map
                
                const card = document.createElement('div');
                card.className = 'card';
                const fullPath = folderPath + filename;
                const ext = filename.split('.').pop().toLowerCase();
                const isVideo = ['mp4', 'webm', 'mov', 'avi'].includes(ext);

                let mediaEl;
                if (isVideo) {
                    mediaEl = document.createElement('video');
                    mediaEl.src = fullPath;
                    mediaEl.controls = true;
                } else {
                    mediaEl = document.createElement('img');
                    mediaEl.dataset.src = fullPath;
                    mediaEl.className = "lazy";
                    // CLICK TO OPEN
                    mediaEl.onclick = () => openLightbox(index);
                }
                card.appendChild(mediaEl);
                container.appendChild(card);
            });
            initLazyLoading();
        }

        function initLazyLoading() {
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.src = entry.target.dataset.src;
                        entry.target.classList.remove("lazy");
                        obs.unobserve(entry.target);
                    }
                });
            });
            document.querySelectorAll("img.lazy").forEach(img => observer.observe(img));
        }

        // --- LIGHTBOX LOGIC ---
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        
        // State
        let scale = 1, pointX = 0, pointY = 0;
        let startX = 0, startY = 0, isDragging = false;
        let initialPinchDist = 0, initialScale = 1;

        function openLightbox(index) {
            currentIndex = index;
            updateLightboxImage();
            lightbox.style.display = "flex";
        }

        function updateLightboxImage() {
            resetZoom();
            const filename = currentFiles[currentIndex];
            // Check if it's video or image (simple check)
            const ext = filename.split('.').pop().toLowerCase();
            if(['mp4','mov'].includes(ext)) return; // Skip videos in this lightbox version
            
            lbImg.src = "private-media/" + filename;
        }

        function changeImage(direction, e) {
            if(e) e.stopPropagation(); // Prevent triggering background click
            
            currentIndex += direction;
            // Loop around
            if (currentIndex < 0) currentIndex = currentFiles.length - 1;
            if (currentIndex >= currentFiles.length) currentIndex = 0;
            
            updateLightboxImage();
        }

        function resetZoom() {
            scale = 1; pointX = 0; pointY = 0;
            lbImg.style.transform = `translate(0px, 0px) scale(1)`;
        }

        function updateTransform() {
            lbImg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }

        // --- INTERACTION HANDLERS ---

        // 1. CLICK ZONES (Left/Right side of screen to nav)
        lightbox.addEventListener('click', (e) => {
            // If dragging occurred, ignore click
            if(isDragging) return;
            
            // Only navigate if we are NOT zoomed in
            if (scale === 1 && e.target !== lbImg) {
                const width = window.innerWidth;
                if (e.clientX < width * 0.25) changeImage(-1);
                else if (e.clientX > width * 0.75) changeImage(1);
            }
        });

        // 2. DOUBLE CLICK/TAP (Close)
        let lastTap = 0;
        lightbox.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0 && scale === 1) {
                lightbox.style.display = "none"; // Double tap to close
                lbImg.src = "";
            }
            lastTap = currentTime;
        });

        lightbox.addEventListener('dblclick', () => {
            if(scale === 1) {
                lightbox.style.display = "none";
                lbImg.src = "";
            } else {
                resetZoom(); // If zoomed in, double click resets zoom
            }
        });

        // 3. ZOOM & PAN LOGIC
        lightbox.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = -Math.sign(e.deltaY);
            const nextScale = scale + (delta * 0.2);
            if (nextScale >= 1 && nextScale <= 5) scale = nextScale;
            if(scale === 1) resetZoom();
            updateTransform();
        });

        // TOUCH & MOUSE EVENTS
        lbImg.addEventListener('mousedown', startDrag);
        lbImg.addEventListener('touchstart', startDrag);

        window.addEventListener('mousemove', moveDrag);
        window.addEventListener('touchmove', moveDrag, { passive: false });

        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);

        function startDrag(e) {
            // e.preventDefault(); // Removed to allow click events to pass if not moving
            isDragging = false;
            
            if (e.type === 'touchstart') {
                if(e.touches.length === 2) {
                    initialPinchDist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    initialScale = scale;
                }
                startX = e.touches[0].clientX - pointX;
                startY = e.touches[0].clientY - pointY;
            } else {
                startX = e.clientX - pointX;
                startY = e.clientY - pointY;
            }
        }

        function moveDrag(e) {
            // Pinch Zoom
            if(e.type === 'touchmove' && e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                scale = Math.min(Math.max(1, initialScale * (dist / initialPinchDist)), 5);
                updateTransform();
                return;
            }

            // Panning
            let clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            let clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

            // Detect if we are actually dragging
            if (scale > 1) {
                 e.preventDefault();
                 isDragging = true;
                 pointX = clientX - startX;
                 pointY = clientY - startY;
                 updateTransform();
            } else if (scale === 1 && e.type === 'touchmove') {
                // OPTIONAL: SWIPE LOGIC FOR MOBILE
                // Simple swipe detection could go here to change image
                // But for now, we rely on Tap Zones to avoid conflict with vertical scroll
            }
        }

        function endDrag() {
            setTimeout(() => { isDragging = false; }, 50);
        }

    </script>
</body>
</html>